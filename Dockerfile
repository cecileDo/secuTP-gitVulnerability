FROM ubuntu

#update package list
RUN apt-get update

#install libraries to build old git version
RUN apt-get install -y  \
  ssh \
  bash \
  wget \
  make \
  man \
  gettext \
  gcc \
  zlib1g-dev \
  libssl-dev \
  libcurl4-openssl-dev \
  libexpat1-dev \
  zip 
RUN apt-get install -y  \
  dh-autoreconf \
  docbook2x \
  install-info \
  less
 # for a fixed  git version   #git=2.12.1

# install asccidoc in serverals times because it crash ..
# load package required by asccidoc 
RUN apt-get install -y  python ||  apt-get install -y  python||  apt-get install -y  python # for ascci doc
RUN apt-get install -y  libxml2-utils  # for ascci doc
# install asccidoc serverals times (only if not ok) because of proxy faild .. to be removed if no proxy or good proxy
RUN  export DEBIAN_FRONTEND=noninteractive ; apt-get install -y asciidoc|| apt-get install -y asciidoc || apt-get install -y asciidoc

####### install git version with errors from zip on install dir #####################""
#get archive of git V2.12.2 Before fix version
RUN   mkdir install;cd install ;wget  -O git.zip https://github.com/git/git/archive/v2.12.2.zip

#unzip archive an 
RUN cd install; unzip git.zip

#make default configuration
RUN cd install/git-* ;make configure

# set up install paths  to make a global install
RUN cd install/git-* ;./configure --prefix=/usr --without-tcltk

#build git from sources
RUN cd install/git-* ; make all info doc

#install builded version
RUN cd install/git-*; make install install-info install-doc install-html

ENV GIT_MAN_VIEWER=less
ENV PAGER=less

# Key generation on the server
RUN ssh-keygen -A

WORKDIR /git-server/

# -D flag avoids password generation
# -s flag changes user's shell
RUN mkdir /git-server/keys \
  && adduser --home /home/git --shell /usr/bin/git-shell --disabled-password --gecos "" git \
  && echo git:123456 | chpasswd \
  && mkdir /home/git/.ssh

COPY git-shell-commands /home/git/git-shell-commands

## for tests
RUN adduser --home /home/user1  --disabled-password --gecos "" user1 \
  && echo user1:user1 | chpasswd \
  && mkdir /home/user1/.ssh

# sshd_config file is edited for enable access key and disable access password
COPY sshd_config /etc/ssh/sshd_config
RUN mkdir -p  /run/sshd
COPY start.sh start.sh
RUN chmod +x start.sh

EXPOSE 22

CMD ["sh", "start.sh"]
