FROM ubuntu

#update package list
RUN apt-get update

#install libraries to build old git version
RUN export DEBIAN_FRONTEND=noninteractive ; apt-get update && apt-get install -y  \
  bash \ 
  dh-autoreconf \
  docbook2x \
  gcc \
  gettext \
  install-info \
  less \
  libcurl4-openssl-dev \
  libexpat1-dev \
  libssl-dev \
  make \
  man \
  ssh \
  wget \
  xmlto \
  zip \
  zlib1g-dev 
 
  
 # for a fixed  git version   #git=2.12.1

# install asccidoc in serverals times because it crash ..
# load package required by asccidoc 
RUN apt-get install -y  python ||  apt-get install -y  python||  apt-get install -y  python # for ascci doc
RUN apt-get install -y  libxml2-utils  # for ascci doc

####### install git version with errors from zip on install dir #####################""
#get archive of git V2.12.2 Before fix version
RUN   mkdir install;cd install ;wget  -O git.zip https://github.com/git/git/archive/v2.12.2.zip

#unzip archive  
RUN cd install; unzip git.zip

#make default configuration
RUN cd install/git-* ;make configure

# set up install paths  to make a global install
RUN cd install/git-* ;./configure --prefix=/usr --without-tcltk

#build and install git from sources
RUN cd install/git-* ; make all ;make install

#git doc need asciidoc asciidoc nead git
RUN cd install ; git clone https://github.com/asciidoc/asciidoc asciidoc-8.6.9
RUN cd install/asciidoc* ; git checkout 8.6.9; autoconf; ./configure; make install

RUN cd install/git-* ; make info doc

#install doc builded version
RUN cd install/git-*; make  install-info install-doc install-html

####### End install git version with errors from zip on install dir #####################""

ENV GIT_MAN_VIEWER=less
ENV PAGER=less

# Key generation on the server
RUN ssh-keygen -A

WORKDIR /git-server/

#create geit user
RUN mkdir /git-server/keys \
  && adduser --home /home/git --disabled-password --gecos "" git \
  && echo git:123456 | chpasswd \
  && mkdir /home/git/.ssh \
  && chmod 700 /home/git

RUN echo "/usr/bin/git-shell" >> /etc/shells
## for tests
RUN adduser --home /home/user1  --disabled-password --gecos "" user1 \
  && echo user1:user1 | chpasswd \
  && mkdir /home/user1/.ssh &&  chown -R user1:user1 /home/user1/.ssh \
  && chmod 700 /home/user1/.ssh \
  && su user1 &&  ssh-keygen -t rsa -P "" -f '/home/user1/.ssh/id_rsa' -q 
RUN chown user1:user1 /home/user1/.ssh/id_rsa
 

#copy user git ssh key
RUN cat /home/user1/.ssh/id_rsa.pub > /home/git/.ssh/authorized_keys
 

RUN mkdir -p  /run/sshd

#script for starting server ssh 
COPY start.sh start.sh
RUN chmod +x start.sh

EXPOSE 22

CMD ["sh", "start.sh"]
